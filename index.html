<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MUC Hospital</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  min-height:100vh;
  background:#5a0f0b;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  background:#fff;
  padding:30px;
  width:350px;
  border-radius:15px;
}
.hidden{display:none}
input,select,button{
  width:100%;
  padding:10px;
  margin:8px 0;
}
button{
  background:#5a0f0b;
  color:white;
  border:none;
  cursor:pointer;
}
.box{
  background:#f3f3f3;
  padding:15px;
  margin:10px 0;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="card">
  <h3>Login</h3>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p><a href="#" onclick="showRegister()">Create account</a></p>
</div>

<!-- REGISTER -->
<div id="registerBox" class="card hidden">
  <h3>Register</h3>
  <input id="regName" placeholder="Name">
  <input id="regEmail" placeholder="Email">
  <input id="regPassword" type="password" placeholder="Password">
  <select id="regRole">
    <option value="patient">Patient</option>
    <option value="doctor">Doctor</option>
  </select>
  <button onclick="register()">Register</button>
  <p><a href="#" onclick="showLogin()">Back to login</a></p>
</div>

<!-- ADMIN -->
<div id="adminBox" class="card hidden">
  <h3>Admin Dashboard</h3>
  <div id="doctors"></div>
  <button onclick="logout()">Logout</button>
</div>

<!-- PATIENT -->
<div id="patientBox" class="card hidden">
  <h3>Patient Dashboard</h3>
  <p>Welcome Patient üë§</p>
  <button onclick="logout()">Logout</button>
</div>

<!-- DOCTOR -->
<div id="doctorBox" class="card hidden">
  <h3>Doctor Dashboard</h3>
  <p>Welcome Doctor üë®‚Äç‚öïÔ∏è</p>
  <button onclick="logout()">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyCGG8qc9y4q8P9p498pWxFNDg4wz_uzjnY",
  authDomain:"muc-hospital.firebaseapp.com",
  projectId:"muc-hospital"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

/* UI elements */
const loginBox=document.getElementById("loginBox");
const registerBox=document.getElementById("registerBox");
const adminBox=document.getElementById("adminBox");
const patientBox=document.getElementById("patientBox");
const doctorBox=document.getElementById("doctorBox");
const doctorsDiv=document.getElementById("doctors");

/* Navigation */
window.showRegister=()=>{
  loginBox.classList.add("hidden");
  registerBox.classList.remove("hidden");
};
window.showLogin=()=>{
  registerBox.classList.add("hidden");
  loginBox.classList.remove("hidden");
};

/* Register */
window.register=async()=>{
  const u=await createUserWithEmailAndPassword(
    auth,
    regEmail.value,
    regPassword.value
  );
  await setDoc(doc(db,"users",u.user.uid),{
    name:regName.value,
    email:regEmail.value,
    role:regRole.value,
    status: regRole.value==="doctor" ? "pending" : "active"
  });
  alert("Account created");
  showLogin();
};

/* Login */
window.login=async()=>{
  await signInWithEmailAndPassword(
    auth,
    loginEmail.value,
    loginPassword.value
  );
};

/* Logout */
window.logout=async()=>{
  await signOut(auth);
};

/* AUTH STATE (ÿßŸÑŸÖŸáŸÖ ÿ¨ÿØŸãÿß) */
onAuthStateChanged(auth, async user=>{
  // reset
  loginBox.classList.add("hidden");
  registerBox.classList.add("hidden");
  adminBox.classList.add("hidden");
  patientBox.classList.add("hidden");
  doctorBox.classList.add("hidden");

  if(!user){
    loginBox.classList.remove("hidden");
    return;
  }

  const snap=await getDoc(doc(db,"users",user.uid));
  const data=snap.data();

  if(data.role==="admin"){
    adminBox.classList.remove("hidden");
    loadDoctors();
  }

  if(data.role==="patient"){
    patientBox.classList.remove("hidden");
  }

  if(data.role==="doctor"){
    if(data.status!=="active"){
      alert("Doctor pending approval");
      await signOut(auth);
      loginBox.classList.remove("hidden");
      return;
    }
    doctorBox.classList.remove("hidden");
  }
});

/* Admin approve doctors */
async function loadDoctors(){
  doctorsDiv.innerHTML="";
  const q=query(
    collection(db,"users"),
    where("role","==","doctor"),
    where("status","==","pending")
  );
  const s=await getDocs(q);
  s.forEach(d=>{
    doctorsDiv.innerHTML+=`
      <div class="box">
        ${d.data().name}<br>
        <button onclick="approve('${d.id}')">Approve</button>
      </div>`;
  });
}

window.approve=async(id)=>{
  await updateDoc(doc(db,"users",id),{status:"active"});
  loadDoctors();
};
</script>

</body>
</html>
