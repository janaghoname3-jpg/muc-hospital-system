<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>MUC Hospital - Admin System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
/* Styles */
:root { --primary: #800000; --bg: #f0f2f5; --text: #333; --success: #28a745; --danger: #dc3545; --warning: #ffc107; }
body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; color: var(--text); }
header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
button { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-family: inherit; font-weight: bold; }
.btn-main { background: var(--primary); color: white; width: 100%; margin-top: 10px; padding: 12px; }
.btn-success { background: var(--success); color: white; }
.btn-nav { background: white; color: var(--primary); border: 1px solid var(--primary); margin: 5px; }
.btn-logout { background: white; color: var(--danger); border: 1px solid var(--danger); }
.container { max-width: 900px; margin: 30px auto; padding: 0 15px; }
.card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
.hidden { display: none !important; }
input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
.list-item { background: #fff; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
.badge { padding: 4px 8px; border-radius: 12px; color: white; font-size: 0.8rem; }
</style>
</head>
<body>

<header>
  <h2>ğŸ¥ MUC Admin System</h2>
  <div id="navArea"></div>
</header>

<div class="container">
  <div id="authScreen" class="card" style="max-width: 400px; margin: 50px auto;">
    <h3 id="formTitle" style="text-align:center; color:var(--primary)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input type="text" id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="hidden">
    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    
    <div id="regOptions" class="hidden">
      <label>Ø£Ø±ÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒÙ€:</label>
      <select id="role">
        <option value="patient">Ù…Ø±ÙŠØ¶ (Patient)</option>
        <option value="doctor">Ø¯ÙƒØªÙˆØ± (Doctor)</option>
        <option value="admin">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… (Admin)</option>
      </select>
      <p style="font-size:0.8rem; color:#d9534f">* Ù…Ù„Ø§Ø­Ø¸Ø©: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯ÙƒØªÙˆØ± ÙŠØªØ·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†.</p>
    </div>

    <button onclick="authHandler()" class="btn-main">ØªÙ†ÙÙŠØ°</button>
    <p style="text-align:center; cursor:pointer; margin-top:15px; color:#555" onclick="toggleForm()" id="toggleText">Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</p>
  </div>

  <div id="dashboard" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 id="welcomeText" style="color:var(--primary); margin:0"></h3>
      <span id="roleBadge" class="badge" style="background:#555"></span>
    </div>
    <div id="menuTabs" style="margin-bottom:20px;"></div>
    <div id="mainContent"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({ apiKey: "AIzaSyCGG8qc9y4q8P9p498pWxFNDg4wz_uzjnY", authDomain: "muc-hospital.firebaseapp.com", projectId: "muc-hospital" });
const auth = getAuth(app);
const db = getFirestore(app);

let userMode = true; let currentUser = null;
const authScreen = document.getElementById('authScreen');
const dashboard = document.getElementById('dashboard');
const mainContent = document.getElementById('mainContent');

// 1. AUTH
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const snap = await getDoc(doc(db, "users", user.uid));
    if (snap.exists()) {
      currentUser = { uid: user.uid, ...snap.data() };
      
      // Check Pending Doctor
      if (currentUser.role === 'doctor' && currentUser.status === 'pending') {
        alert("â›” Ø¹Ø°Ø±Ø§Ù‹! Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.");
        await signOut(auth);
        return;
      }
      openDashboard();
    }
  } else { currentUser = null; openLogin(); }
});

window.toggleForm = () => {
  userMode = !userMode;
  document.getElementById('formTitle').innerText = userMode ? "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" : "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
  document.getElementById('toggleText').innerText = userMode ? "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨" : "Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„";
  document.getElementById('fullName').classList.toggle('hidden', userMode);
  document.getElementById('regOptions').classList.toggle('hidden', userMode);
};

window.authHandler = async () => {
  const email = document.getElementById('email').value;
  const pass = document.getElementById('password').value;
  try {
    if (userMode) {
      await signInWithEmailAndPassword(auth, email, pass);
    } else {
      const name = document.getElementById('fullName').value;
      const role = document.getElementById('role').value;
      if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
      
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const status = (role === 'doctor') ? 'pending' : 'active'; // Logic: Doctor Pending

      await setDoc(doc(db, "users", cred.user.uid), {
        name, email, role, status, createdAt: serverTimestamp()
      });
      alert(role === 'doctor' ? "ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„! Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†." : "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
    }
  } catch (e) { alert("Error: " + e.message); }
};
window.logout = async () => { await signOut(auth); location.reload(); };

// 2. DASHBOARD
function openLogin() { authScreen.classList.remove('hidden'); dashboard.classList.add('hidden'); document.getElementById('navArea').innerHTML = ''; }
function openDashboard() {
  authScreen.classList.add('hidden'); dashboard.classList.remove('hidden');
  document.getElementById('navArea').innerHTML = `<button onclick="logout()" class="btn-logout">Ø®Ø±ÙˆØ¬</button>`;
  document.getElementById('welcomeText').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.name}`;
  document.getElementById('roleBadge').innerText = currentUser.role.toUpperCase();
  
  const menu = document.getElementById('menuTabs');
  menu.innerHTML = "";

  if (currentUser.role === 'admin') {
    menu.innerHTML = `
      <button class="btn-nav" onclick="adminDoctors()">ğŸ‘¨â€âš•ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©</button>
      <button class="btn-nav" onclick="adminAllAppts()">ğŸ“… ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
    `;
    adminDoctors();
  } else if (currentUser.role === 'patient') {
    menu.innerHTML = `
      <button class="btn-nav" onclick="patBook()">â• Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</button>
      <button class="btn-nav" onclick="patList()">ğŸ“‚ Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ</button>
    `;
    patBook();
  } else if (currentUser.role === 'doctor') {
    menu.innerHTML = `<button class="btn-nav">ğŸ“… Ø¬Ø¯ÙˆÙ„ÙŠ</button>`;
    docAppts();
  }
}

// === ADMIN LOGIC ===
window.adminDoctors = async () => {
  mainContent.innerHTML = "<h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©</h3>";
  const q = query(collection(db, "users"), where("role", "==", "doctor"));
  const snap = await getDocs(q);
  
  if(snap.empty) { mainContent.innerHTML += "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙƒØ§ØªØ±Ø©.</p>"; return; }

  snap.forEach(d => {
    const u = d.data();
    const isPending = u.status === 'pending';
    const btn = isPending ? 
      `<button class="btn-success" onclick="acceptDoc('${d.id}')">âœ… Ù‚Ø¨ÙˆÙ„ (Accept)</button>` : 
      `<span style="color:green; font-weight:bold">Ù…ÙØ¹Ù„ Active</span>`;
      
    mainContent.innerHTML += `
      <div class="list-item" style="border-right: 5px solid ${isPending?'orange':'green'}">
        <div><b>${u.name}</b><br><small>${u.email}</small></div>
        <div>${btn}</div>
      </div>`;
  });
};

window.acceptDoc = async (id) => {
  if(confirm("ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙƒØªÙˆØ±ØŸ")) {
    await updateDoc(doc(db, "users", id), { status: 'active' });
    alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„!"); adminDoctors();
  }
};

window.adminAllAppts = async () => {
  mainContent.innerHTML = "<h3>Ø³Ø¬Ù„ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h3>";
  const snap = await getDocs(collection(db, "appointments"));
  if(snap.empty) { mainContent.innerHTML += "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯.</p>"; return; }
  
  snap.forEach(d => {
    const a = d.data();
    mainContent.innerHTML += `
      <div class="list-item">
        <div>
           Ù…Ø±ÙŠØ¶: <b>${a.patientName}</b> â¡ï¸ Ø¯ÙƒØªÙˆØ±: <b>${a.doctorName}</b><br>
           ğŸ“… ${a.date} Ø§Ù„Ø³Ø§Ø¹Ø© ${a.time}
        </div>
        <span class="badge" style="background:${a.status==='pending'?'orange':'green'}">${a.status}</span>
      </div>`;
  });
};

// === PATIENT LOGIC ===
window.patBook = async () => {
  // Only show ACTIVE doctors
  const q = query(collection(db, "users"), where("role", "==", "doctor"), where("status", "==", "active"));
  const docs = await getDocs(q);
  
  let opts = `<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙƒØªÙˆØ± --</option>`;
  docs.forEach(d => opts += `<option value="${d.id}" data-name="${d.data().name}">${d.data().name}</option>`);

  mainContent.innerHTML = `
    <div class="card">
      <h3>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</h3>
      <select id="selDoc">${opts}</select>
      <input type="date" id="selDate">
      <input type="time" id="selTime">
      <button class="btn-main" onclick="confirmBook()">Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†</button>
    </div>`;
};

window.confirmBook = async () => {
  const sel = document.getElementById('selDoc');
  const dName = sel.options[sel.selectedIndex].getAttribute('data-name');
  await addDoc(collection(db, "appointments"), {
    patientId: currentUser.uid, patientName: currentUser.name,
    doctorId: sel.value, doctorName: dName,
    date: document.getElementById('selDate').value,
    time: document.getElementById('selTime').value,
    status: 'pending'
  });
  alert("ØªÙ… Ø§Ù„Ø­Ø¬Ø²! Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†."); patList();
};

window.patList = async () => {
  const q = query(collection(db, "appointments"), where("patientId", "==", currentUser.uid));
  const snap = await getDocs(q);
  mainContent.innerHTML = "<h3>Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ</h3>";
  snap.forEach(d => mainContent.innerHTML += `<div class="list-item">ğŸ“… ${d.data().date} Ù…Ø¹ Ø¯. ${d.data().doctorName}</div>`);
};

// === DOCTOR LOGIC ===
window.docAppts = async () => {
  const q = query(collection(db, "appointments"), where("doctorId", "==", currentUser.uid));
  const snap = await getDocs(q);
  mainContent.innerHTML = "<h3>Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø±Ø¶Ù‰</h3>";
  snap.forEach(d => mainContent.innerHTML += `<div class="list-item">Ù…Ø±ÙŠØ¶: ${d.data().patientName} - ${d.data().date}</div>`);
};
</script>
</body>
</html>
